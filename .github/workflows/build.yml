# name: Compile Latex and create output

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     # container: ghcr.io/xu-cheng/texlive-full:latest
#     permissions:
#       contents: write

#     steps:
#       - name: Checkout
#         uses: actions/checkout@v4

#       - name: Set up Python
#         uses: actions/setup-python@v4
#         with:
#           python-version: "3.x"

#       - name: Pull
#         run: git pull origin main

#       - name: Compile
#         run: python .github/workflows/main.py

#       - name: Mark repo as safe
#         run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

#       - name: Commit and push PDFs
#         run: |
#           git config --global user.name "github-actions[bot]"
#           git config --global user.email "github-actions[bot]@users.noreply.github.com"
#           git add .
#           git commit -m "Automated PDF compilation update"
#           git push origin main
name: Compile LaTeX and Push PDFs

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions: {} # Non usiamo GITHUB_TOKEN default

    steps:
      # 1. Genera il token della GitHub App (con bypass)
      - name: Genera Installation Token
        id: app_token
        uses: actions/github-script@v7
        with:
          script: |
            const jwt = require('jsonwebtoken');
            const privateKey = process.env.APP_PRIVATE_KEY;
            const appId = process.env.APP_ID;
            const installationId = process.env.INSTALLATION_ID;

            const now = Math.floor(Date.now() / 1000);
            const payload = { iat: now, exp: now + 600, iss: appId };
            const jwtToken = jwt.sign(payload, privateKey, { algorithm: 'RS256' });

            const response = await github.request('POST /app/installations/{installation_id}/access_tokens', {
              installation_id: installationId,
              headers: { authorization: `Bearer ${jwtToken}` }
            });
            return response.data.token;
        env:
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
          APP_ID: ${{ secrets.APP_ID }}
          INSTALLATION_ID: ${{ secrets.INSTALLATION_ID }}

      # 2. Checkout con token dell'app
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ steps.app_token.outputs.result }}
          ref: main

      # 3. Setup Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      # 4. Installa TeX Live (contenitore leggero)
      - name: Install TeX Live
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-full

      # 5. Esegui il tuo script Python (che compila LaTeX)
      - name: Compile LaTeX
        run: python .github/workflows/main.py

      # 6. Commit e push PDFs (con bypass!)
      - name: Commit and Push PDFs
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          git add .
          git commit -m "Auto: PDF compilati e aggiornati" || echo "Nessun cambiamento da committare"
          git push origin main
